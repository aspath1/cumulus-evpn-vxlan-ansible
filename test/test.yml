- name: test
  hosts: all
  gather_facts: false
  tasks:

  - include_vars:
      dir: "{{ playbook_vars }}"

  - name: check bond vlans against tenant vlans
    set_fact:
      tenant_vlans: "{{ tenants | map(attribute='vlans') | flatten | map(attribute='id') | list }}"

  - name: check bond vlans against tenant vlans
    set_fact:
      bond_vlans: |
        {% set b_rack = bonding | dict2items %}
        {% set b_vlan_format = b_rack | map(attribute='value') | map(attribute='host_bond') | flatten | map(attribute='vids') | join(',') | replace(', ', ',') %}
        {% for item in b_vlan_format.split(',') | unique if (item | int) not in tenant_vlans  %}
        {{ (item | string) + ' ' + 'not in tenant vlans. Check bond.yml and tenants.yml.' + ' ' + 'Tenant Vlans: ' + (tenant_vlans | join(',') | string) }}
        {% endfor %}

  - fail:
      msg="{{ bond_vlans.split('\n') }}"
    when: "bond_vlans != '\n'"


#  - debug: msg="{{ bond_vlans.split('\n') }}"
