- name: bootstrap
  hosts: network-device
  gather_facts: false
  tasks:

  - name: load variables dhcp
    include_vars: "{{ playbook_vars }}/dhcp-host.yml"
    tags: always

  - ping:

  - name: upload ssh key
    authorized_key:
      user: "{{ ansible_user }}"
      key: "{{ lookup('file', '/home/reynold/.ssh/id_rsa.pub') }}"
      state: present
    tags: ssh_key

  - name: check if internet is reachable
    shell: 'ping -c 5 www.google.com'
    register: ping
    failed_when: ping.rc == 2 or ping.rc == 1
    tags: update

  - name: update packages
    apt: update_cache=yes upgrade=dist
    register: update_dist
    tags: update

  - name: reboot switch
    shell: "sleep 5 && reboot"
    async: 1
    poll: 0
    tags: update
    when: update_dist is changed

  - name: waif for switch to boot up
    wait_for_connection: delay=20
    tags: update
    when: update_dist is changed

  - name: add mgmt vrf
    shell: "net add vrf mgmt && net commit"
    async: 1
    poll: 0
    register: mgmt_vrf

  - name: reconnect to switch
    wait_for_connection: delay=5
    when: mgmt_vrf is changed

  - name: add netq server
    shell: "netq config add server {{ name_server }} vrf mgmt && netq config restart agent"
